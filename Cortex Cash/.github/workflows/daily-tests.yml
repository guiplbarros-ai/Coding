name: Daily Test Suite

on:
  schedule:
    # Roda todos os dias √†s 9h UTC (6h BRT)
    - cron: '0 9 * * *'
  workflow_dispatch: # Permite execu√ß√£o manual

jobs:
  daily-tests:
    name: Daily Full Test Suite
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run full test suite with coverage
        run: npm run test:coverage
        env:
          OPENAI_API_KEY: test

      - name: Check test results
        run: |
          TOTAL_TESTS=$(grep -o '"numTotalTests":[0-9]*' coverage/coverage-summary.json | grep -o '[0-9]*')
          FAILED_TESTS=$(grep -o '"numFailedTests":[0-9]*' coverage/coverage-summary.json | grep -o '[0-9]*')

          echo "Total tests: $TOTAL_TESTS"
          echo "Failed tests: $FAILED_TESTS"

          if [ "$FAILED_TESTS" -gt 0 ]; then
            echo "‚ùå $FAILED_TESTS tests failed"
            exit 1
          fi

          echo "‚úÖ All $TOTAL_TESTS tests passed"

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Send notification on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üö® Daily test suite failed',
              body: `The daily test suite has failed.\n\n[View workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['bug', 'tests']
            });
