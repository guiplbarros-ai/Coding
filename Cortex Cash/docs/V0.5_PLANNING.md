# Planejamento v0.5 - Cortex Cash
**Agent CORE: Owner**

**Data de inÃ­cio**: 05 de Novembro de 2025
**DuraÃ§Ã£o estimada**: 2-3 semanas
**Status**: ğŸš§ PLANEJAMENTO

---

## ğŸ¯ VisÃ£o Geral

A **v0.5** Ã© uma versÃ£o **incremental** que melhora e completa funcionalidades existentes antes da grande migraÃ§Ã£o para PostgreSQL (v1.0). Foca em:
- Melhorias de UX
- Completude de features existentes
- PreparaÃ§Ã£o de infraestrutura para v1.0
- Zero mudanÃ§as de schema (estabilidade)

**PrincÃ­pio:** Features que **entregam valor imediato** sem depender de backend multi-user.

---

## ğŸ“¦ Escopo v0.5

### **1. Sistema de ImportaÃ§Ã£o AvanÃ§ado** (Agent DATA - Prioridade ALTA)
**Rationale:** ImportaÃ§Ã£o Ã© o primeiro contato do usuÃ¡rio com o app. Melhorar isso aumenta taxa de adoÃ§Ã£o.

**EntregÃ¡veis:**
- âœ… JÃ¡ temos: ImportaÃ§Ã£o CSV bÃ¡sica
- ğŸ†• Suporte a **OFX** (Open Financial Exchange)
- ğŸ†• Suporte a **PDF** de extratos bancÃ¡rios (OCR com Tesseract.js ou similar)
- ğŸ†• DetecÃ§Ã£o automÃ¡tica aprimorada (mais bancos brasileiros)
- ğŸ†• Preview de importaÃ§Ã£o com validaÃ§Ãµes
- ğŸ†• Mapeamento de colunas customizÃ¡vel (wizard)
- ğŸ†• HistÃ³rico de importaÃ§Ãµes (rastreabilidade)

**Arquivos novos:**
- `lib/import/parsers/ofx.ts`
- `lib/import/parsers/pdf.ts`
- `lib/import/validators/import-validator.ts`
- `app/import/wizard/page.tsx` (multi-step form)
- `components/import/preview-table.tsx`
- `components/import/column-mapper.tsx`

**Schema changes:** NENHUM (usa tabela `templates_importacao` existente)

---

### **2. Drag-and-Drop de Regras** (Agent APP - Prioridade MÃ‰DIA)
**Rationale:** Melhora UX da gestÃ£o de regras de classificaÃ§Ã£o. Permite ao usuÃ¡rio visualizar e ajustar prioridades intuitivamente.

**EntregÃ¡veis:**
- ğŸ†• ReordenaÃ§Ã£o de regras por drag-and-drop (dnd-kit)
- ğŸ†• AtualizaÃ§Ã£o automÃ¡tica de prioridades
- ğŸ†• Feedback visual durante drag
- ğŸ†• Persist changes imediatamente no IndexedDB

**Arquivos modificados:**
- `app/settings/classification-rules/page.tsx`

**DependÃªncias:**
- `@dnd-kit/core`
- `@dnd-kit/sortable`
- `@dnd-kit/utilities`

**Schema changes:** NENHUM (campo `prioridade` jÃ¡ existe)

---

### **3. Dashboard Analytics AvanÃ§ado** (Agent APP - Prioridade MÃ‰DIA)
**Rationale:** UsuÃ¡rios querem insights mais profundos sobre seus gastos. Aumenta engajamento.

**EntregÃ¡veis:**
- ğŸ†• **EvoluÃ§Ã£o de Gastos por Categoria** (Ãºltimos 6 meses)
- ğŸ†• **Top 10 Maiores Despesas** (mÃªs atual)
- ğŸ†• **AnÃ¡lise de TendÃªncias** (mÃªs vs mÃªs anterior %)
- ğŸ†• **Breakdown Receitas vs Despesas** (comparativo anual)
- ğŸ†• **Taxa de Saving** (receitas - despesas / receitas)
- ğŸ†• **GrÃ¡fico de Sankey** (fluxo de dinheiro: fonte â†’ categoria â†’ tipo)

**Componentes novos:**
- `components/analytics/expense-evolution-chart.tsx`
- `components/analytics/top-expenses-widget.tsx`
- `components/analytics/trend-analysis.tsx`
- `components/analytics/saving-rate-card.tsx`
- `components/analytics/sankey-flow-chart.tsx` (recharts ou d3)

**PÃ¡ginas novas:**
- `app/analytics/page.tsx` (nova seÃ§Ã£o)

**Schema changes:** NENHUM (usa dados de `transacoes`)

---

### **4. Melhorias em OrÃ§amentos** (Agent APP - Prioridade BAIXA)
**Rationale:** OrÃ§amentos jÃ¡ existem mas precisam de refinamento para ficar production-ready.

**EntregÃ¡veis:**
- ğŸ†• **ProjeÃ§Ãµes de orÃ§amento** (mÃ©dia mÃ³vel dos Ãºltimos 3 meses)
- ğŸ†• **Comparativo OrÃ§ado vs Realizado** (grÃ¡fico barras)
- ğŸ†• **Alertas visuais** (card vermelho quando > 100%)
- ğŸ†• **HistÃ³rico de orÃ§amentos** (visualizaÃ§Ã£o mÃªs a mÃªs)
- ğŸ†• **SugestÃµes de orÃ§amento** baseadas em histÃ³rico

**Componentes novos:**
- `components/budget/projection-chart.tsx`
- `components/budget/comparison-card.tsx`
- `components/budget/history-table.tsx`
- `components/budget/smart-suggestions.tsx`

**Arquivos modificados:**
- `app/budgets/page.tsx`

**Schema changes:** NENHUM (tabela `orcamentos` jÃ¡ existe)

---

### **5. Testes Automatizados** (Agent CORE - Prioridade ALTA)
**Rationale:** Estabilidade antes da v1.0. Garantir que migraÃ§Ãµes nÃ£o quebrem funcionalidades core.

**EntregÃ¡veis:**
- ğŸ†• **Testes unitÃ¡rios** (services crÃ­ticos)
  - `transacao.service.test.ts`
  - `categoria.service.test.ts`
  - `regra-classificacao.service.test.ts`
- ğŸ†• **Testes de integraÃ§Ã£o** (API routes)
  - `/api/ai/classify` (mock OpenAI)
  - `/api/ai/usage`
- ğŸ†• **Fixtures** (dados de teste)
- ğŸ†• **Setup Jest** ou **Vitest**

**Arquivos novos:**
- `tests/unit/services/*.test.ts`
- `tests/integration/api/*.test.ts`
- `tests/fixtures/transactions.ts`
- `vitest.config.ts` (ou `jest.config.js`)

**Schema changes:** NENHUM

---

## ğŸ—ï¸ Arquitetura

### **PrincÃ­pios da v0.5:**
1. **Zero breaking changes** - MantÃ©m compatibilidade total com v0.4
2. **Progressive enhancement** - Features adicionam valor sem reescrever existentes
3. **Preparation for v1.0** - CÃ³digo organizado para facilitar migraÃ§Ã£o Dexie â†’ Supabase
4. **Test coverage** - Aumentar cobertura de 15% para 40%+

### **Estrutura de Pastas (Novas)**
```
lib/
â”œâ”€â”€ import/
â”‚   â”œâ”€â”€ parsers/
â”‚   â”‚   â”œâ”€â”€ ofx.ts (NOVO)
â”‚   â”‚   â””â”€â”€ pdf.ts (NOVO)
â”‚   â””â”€â”€ validators/
â”‚       â””â”€â”€ import-validator.ts (NOVO)
â”‚
app/
â”œâ”€â”€ import/
â”‚   â””â”€â”€ wizard/
â”‚       â””â”€â”€ page.tsx (NOVO)
â”‚
â”œâ”€â”€ analytics/
â”‚   â””â”€â”€ page.tsx (NOVO)
â”‚
components/
â”œâ”€â”€ import/
â”‚   â”œâ”€â”€ preview-table.tsx (NOVO)
â”‚   â””â”€â”€ column-mapper.tsx (NOVO)
â”‚
â”œâ”€â”€ analytics/
â”‚   â”œâ”€â”€ expense-evolution-chart.tsx (NOVO)
â”‚   â”œâ”€â”€ top-expenses-widget.tsx (NOVO)
â”‚   â”œâ”€â”€ trend-analysis.tsx (NOVO)
â”‚   â”œâ”€â”€ saving-rate-card.tsx (NOVO)
â”‚   â””â”€â”€ sankey-flow-chart.tsx (NOVO)
â”‚
â”œâ”€â”€ budget/
â”‚   â”œâ”€â”€ projection-chart.tsx (NOVO)
â”‚   â”œâ”€â”€ comparison-card.tsx (NOVO)
â”‚   â”œâ”€â”€ history-table.tsx (NOVO)
â”‚   â””â”€â”€ smart-suggestions.tsx (NOVO)
â”‚
tests/
â”œâ”€â”€ unit/
â”‚   â””â”€â”€ services/
â”‚       â”œâ”€â”€ transacao.service.test.ts (NOVO)
â”‚       â”œâ”€â”€ categoria.service.test.ts (NOVO)
â”‚       â””â”€â”€ regra-classificacao.service.test.ts (NOVO)
â”‚
â”œâ”€â”€ integration/
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ ai-classify.test.ts (NOVO)
â”‚       â””â”€â”€ ai-usage.test.ts (NOVO)
â”‚
â””â”€â”€ fixtures/
    â””â”€â”€ transactions.ts (NOVO)
```

---

## ğŸ“Š Schema Changes

**NENHUMA mudanÃ§a de schema na v0.5.**

**Rationale:**
- v0.5 Ã© incremental e reutiliza estrutura existente
- MudanÃ§as de schema virÃ£o em v1.0 (migraÃ§Ã£o para PostgreSQL)
- Estabilidade Ã© prioridade antes da grande migraÃ§Ã£o

---

## ğŸ”— DependÃªncias Novas

```json
{
  "dependencies": {
    "@dnd-kit/core": "^6.1.0",
    "@dnd-kit/sortable": "^8.0.0",
    "@dnd-kit/utilities": "^3.2.2",
    "ofx": "^0.5.0",
    "tesseract.js": "^5.0.4" // OCR para PDFs (opcional)
  },
  "devDependencies": {
    "vitest": "^1.0.0",
    "@testing-library/react": "^14.0.0",
    "@testing-library/jest-dom": "^6.0.0",
    "msw": "^2.0.0" // Mock Service Worker
  }
}
```

---

## ğŸ‘¥ DivisÃ£o de Tarefas por Agente

### **Agent CORE (CoordenaÃ§Ã£o + Infraestrutura)**
1. âœ… Criar planejamento v0.5 (este documento)
2. â³ Setup de testes (Vitest + fixtures)
3. â³ Escrever testes unitÃ¡rios de services
4. â³ Escrever testes de integraÃ§Ã£o de API
5. â³ CI/CD para rodar testes automaticamente
6. â³ DocumentaÃ§Ã£o tÃ©cnica

### **Agent DATA (Backend + ImportaÃ§Ã£o)**
1. â³ Parser OFX (`lib/import/parsers/ofx.ts`)
2. â³ Parser PDF (`lib/import/parsers/pdf.ts`)
3. â³ Validador de importaÃ§Ãµes (`lib/import/validators/import-validator.ts`)
4. â³ Service de histÃ³rico de importaÃ§Ãµes
5. â³ Testes de parsers

### **Agent APP (Frontend + UX)**
1. â³ Drag-and-drop de regras (dnd-kit)
2. â³ Wizard de importaÃ§Ã£o multi-step
3. â³ PÃ¡gina de Analytics (`/analytics`)
4. â³ 5 componentes de analytics
5. â³ 4 componentes de budget improvements
6. â³ Preview de importaÃ§Ã£o com tabela
7. â³ Column mapper interativo

---

## ğŸ“… Timeline Estimado

### **Semana 1: Setup + ImportaÃ§Ã£o**
- Dia 1-2: Agent CORE - Setup de testes
- Dia 3-5: Agent DATA - Parsers OFX e PDF

### **Semana 2: UX Improvements**
- Dia 1-2: Agent APP - Drag-and-drop de regras
- Dia 3-5: Agent APP - Wizard de importaÃ§Ã£o

### **Semana 3: Analytics + Testes**
- Dia 1-3: Agent APP - PÃ¡gina de Analytics completa
- Dia 4-5: Agent CORE - Escrever testes + CI/CD

**Total:** 2-3 semanas (depende da complexidade do OCR de PDFs)

---

## ğŸ¯ MÃ©tricas de Sucesso

### **Funcionalidades:**
- [ ] ImportaÃ§Ã£o OFX funcionando com 3+ bancos brasileiros
- [ ] Drag-and-drop de regras com <100ms de latÃªncia
- [ ] Analytics com 5+ visualizaÃ§Ãµes implementadas
- [ ] OrÃ§amentos com projeÃ§Ãµes precisas (Â±10%)

### **Qualidade:**
- [ ] Cobertura de testes > 40%
- [ ] Build passa sem warnings
- [ ] Lighthouse score > 90

### **Performance:**
- [ ] ImportaÃ§Ã£o de 10k transaÃ§Ãµes em < 5s
- [ ] Analytics renderizam em < 1s
- [ ] Drag-and-drop sem lag perceptÃ­vel

---

## ğŸš§ Riscos e MitigaÃ§Ãµes

### **Risco 1: OCR de PDFs pode ser complexo**
**MitigaÃ§Ã£o:** Implementar como feature opcional. Se complicar, deixar para v0.6.

### **Risco 2: dnd-kit pode ter conflitos com Next.js 16**
**MitigaÃ§Ã£o:** Testar early. Se houver problemas, usar alternativa (react-beautiful-dnd).

### **Risco 3: Testes podem atrasar timeline**
**MitigaÃ§Ã£o:** Focar em testes crÃ­ticos primeiro (services core). Expandir depois.

---

## ğŸ“š ReferÃªncias

- **Roadmap Original:** `docs/ROADMAP_SUMMARY.md`
- **Status v0.4:** `docs/STATUS_AGENTES.md`
- **Data Model:** `docs/architecture/DATA_MODEL.md`
- **OFX Spec:** https://financialdataexchange.org/ofx
- **dnd-kit Docs:** https://docs.dndkit.com/

---

**Ãšltima atualizaÃ§Ã£o:** 05 de Novembro de 2025 - v0.5 PLANEJAMENTO
**PrÃ³ximo passo:** Agent CORE - Setup de testes (Vitest)
