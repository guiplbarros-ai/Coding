# Tasks v0.5 - Distribui√ß√£o por Agente
**Agent CORE: Coordena√ß√£o**

**Data:** 05 de Novembro de 2025
**Status:** üöß PLANEJAMENTO

---

## üéØ Agent CORE - Infraestrutura & Testes

**Responsabilidade:** Setup de testes + testes cr√≠ticos + CI/CD

### **Sprint 1: Setup de Testes (2 dias)**

#### Task 1.1: Configurar Vitest
- [ ] Instalar Vitest e depend√™ncias
  ```bash
  npm install -D vitest @testing-library/react @testing-library/jest-dom happy-dom
  ```
- [ ] Criar `vitest.config.ts`
- [ ] Configurar test environment (happy-dom para componentes)
- [ ] Criar `tests/setup.ts` (global setup)
- [ ] Adicionar scripts em `package.json`:
  - `test`: `vitest`
  - `test:ui`: `vitest --ui`
  - `test:coverage`: `vitest --coverage`

**Arquivos:**
- `vitest.config.ts` (NOVO)
- `tests/setup.ts` (NOVO)
- `package.json` (modificar)

---

#### Task 1.2: Criar Fixtures de Teste
- [ ] `tests/fixtures/transactions.ts` - 50 transa√ß√µes de exemplo
- [ ] `tests/fixtures/categorias.ts` - 13 categorias padr√£o
- [ ] `tests/fixtures/contas.ts` - 3 contas de teste
- [ ] `tests/fixtures/regras.ts` - 5 regras de classifica√ß√£o

**Arquivos:**
- `tests/fixtures/transactions.ts` (NOVO)
- `tests/fixtures/categorias.ts` (NOVO)
- `tests/fixtures/contas.ts` (NOVO)
- `tests/fixtures/regras.ts` (NOVO)

---

### **Sprint 2: Testes Unit√°rios (3 dias)**

#### Task 2.1: Testar transacao.service.ts
- [ ] Test: `createTransacao` com dados v√°lidos
- [ ] Test: `createTransacao` com dados inv√°lidos (valida√ß√£o)
- [ ] Test: `listTransacoes` com filtros
- [ ] Test: `updateTransacao` com ID v√°lido
- [ ] Test: `deleteTransacao` com ID v√°lido
- [ ] Test: `bulkUpdateCategoria` com m√∫ltiplos IDs

**Arquivo:**
- `tests/unit/services/transacao.service.test.ts` (NOVO)

**Cobertura esperada:** 80%+

---

#### Task 2.2: Testar categoria.service.ts
- [ ] Test: `listCategorias` retorna todas
- [ ] Test: `listCategorias` com filtro `ativas: true`
- [ ] Test: `createCategoria` com dados v√°lidos
- [ ] Test: `updateCategoria` com ID v√°lido
- [ ] Test: `deleteCategoria` (soft delete)

**Arquivo:**
- `tests/unit/services/categoria.service.test.ts` (NOVO)

**Cobertura esperada:** 80%+

---

#### Task 2.3: Testar regra-classificacao.service.ts
- [ ] Test: `createRegra` com regex v√°lido
- [ ] Test: `createRegra` com regex inv√°lido (erro)
- [ ] Test: `matchTransacao` com regra `contains`
- [ ] Test: `matchTransacao` com regra `starts_with`
- [ ] Test: `matchTransacao` com regra `ends_with`
- [ ] Test: `matchTransacao` com regra `regex`
- [ ] Test: `previewRegra` retorna matches corretos

**Arquivo:**
- `tests/unit/services/regra-classificacao.service.test.ts` (NOVO)

**Cobertura esperada:** 90%+

---

### **Sprint 3: Testes de Integra√ß√£o (2 dias)**

#### Task 3.1: Testar /api/ai/classify
- [ ] Setup MSW (Mock Service Worker) para mockar OpenAI
- [ ] Test: POST com dados v√°lidos retorna categoria
- [ ] Test: POST com cache hit retorna `cached: true`
- [ ] Test: POST sem OpenAI key retorna erro 500
- [ ] Test: POST com descri√ß√£o vazia retorna erro 400
- [ ] Test: Verifica se log foi criado em `logs_ia`

**Arquivo:**
- `tests/integration/api/ai-classify.test.ts` (NOVO)
- `tests/mocks/openai.ts` (NOVO - mock handler)

---

#### Task 3.2: Testar /api/ai/usage
- [ ] Test: GET retorna estat√≠sticas corretas
- [ ] Test: GET com m√™s espec√≠fico filtra corretamente
- [ ] Test: Verifica c√°lculo de custo_total

**Arquivo:**
- `tests/integration/api/ai-usage.test.ts` (NOVO)

---

### **Sprint 4: CI/CD (1 dia)**

#### Task 4.1: GitHub Actions para Testes
- [ ] Criar `.github/workflows/test.yml`
- [ ] Rodar testes em push para `main`
- [ ] Rodar testes em PRs
- [ ] Gerar coverage report
- [ ] Upload coverage para Codecov (opcional)

**Arquivo:**
- `.github/workflows/test.yml` (NOVO)

---

#### Task 4.2: Pre-commit Hook
- [ ] Instalar `husky`
- [ ] Configurar pre-commit hook para rodar testes antes de commit
- [ ] Configurar lint-staged para TypeScript

**Arquivos:**
- `.husky/pre-commit` (NOVO)
- `package.json` (modificar - lint-staged config)

---

## üîß Agent DATA - Importa√ß√£o Avan√ßada

**Responsabilidade:** Parsers OFX/PDF + valida√ß√µes + hist√≥rico

### **Sprint 1: Parser OFX (3 dias)**

#### Task 1.1: Implementar Parser OFX
- [ ] Instalar biblioteca `ofx` (npm)
- [ ] Criar `lib/import/parsers/ofx.ts`
- [ ] Fun√ß√£o `parseOFX(file: File): Promise<Transaction[]>`
- [ ] Mapear campos OFX ‚Üí schema do Cortex Cash
- [ ] Tratar erros de parsing (arquivo corrupto, formato inv√°lido)
- [ ] Detectar institui√ß√£o financeira pelo `<FID>`

**Arquivo:**
- `lib/import/parsers/ofx.ts` (NOVO)

---

#### Task 1.2: Suporte a M√∫ltiplos Bancos
- [ ] Banco do Brasil (layout espec√≠fico)
- [ ] Bradesco (layout espec√≠fico)
- [ ] Ita√∫ (layout espec√≠fico)
- [ ] Santander (layout espec√≠fico)
- [ ] Inter (layout espec√≠fico)

**Arquivo:**
- `lib/import/mappings/bank-ofx-mappings.ts` (NOVO)

---

#### Task 1.3: Testes do Parser OFX
- [ ] Fixture: OFX do Bradesco (50 transa√ß√µes)
- [ ] Fixture: OFX do Inter (50 transa√ß√µes)
- [ ] Test: Parse de arquivo v√°lido
- [ ] Test: Parse de arquivo inv√°lido (erro esperado)
- [ ] Test: Detec√ß√£o correta de institui√ß√£o

**Arquivo:**
- `tests/unit/parsers/ofx.test.ts` (NOVO)
- `tests/fixtures/ofx/bradesco.ofx` (NOVO)
- `tests/fixtures/ofx/inter.ofx` (NOVO)

---

### **Sprint 2: Parser PDF (Opcional - 3 dias)**

#### Task 2.1: OCR com Tesseract.js
- [ ] Instalar `tesseract.js`
- [ ] Criar `lib/import/parsers/pdf.ts`
- [ ] Fun√ß√£o `extractTextFromPDF(file: File): Promise<string>`
- [ ] Regex para detectar padr√£o de extrato
- [ ] Extrair campos: data, descri√ß√£o, valor, saldo

**Arquivo:**
- `lib/import/parsers/pdf.ts` (NOVO)

**‚ö†Ô∏è RISCO:** OCR pode ser impreciso. Considerar como **feature beta**.

---

### **Sprint 3: Valida√ß√µes & Hist√≥rico (2 dias)**

#### Task 3.1: Validador de Importa√ß√µes
- [ ] Criar `lib/import/validators/import-validator.ts`
- [ ] Validar formato de data
- [ ] Validar formato de valor (locale pt-BR)
- [ ] Detectar transa√ß√µes duplicadas
- [ ] Validar campos obrigat√≥rios

**Arquivo:**
- `lib/import/validators/import-validator.ts` (NOVO)

---

#### Task 3.2: Service de Hist√≥rico de Importa√ß√µes
- [ ] Adicionar tabela `historico_importacoes` (via Dexie migration)
- [ ] Service: `import-history.service.ts`
- [ ] Salvar metadados: arquivo, data, total importado, erros
- [ ] Endpoint: `GET /api/import/history`

**Arquivos:**
- `lib/db/schema.ts` (modificar - adicionar tabela)
- `lib/services/import-history.service.ts` (NOVO)
- `app/api/import/history/route.ts` (NOVO)

---

## üé® Agent APP - UX & Analytics

**Responsabilidade:** Drag-and-drop + Wizard + Analytics + Budget

### **Sprint 1: Drag-and-Drop de Regras (2 dias)**

#### Task 1.1: Implementar dnd-kit
- [ ] Instalar `@dnd-kit/core`, `@dnd-kit/sortable`, `@dnd-kit/utilities`
- [ ] Modificar `app/settings/classification-rules/page.tsx`
- [ ] Wrap lista de regras com `<DndContext>`
- [ ] Implementar `<SortableItem>` para cada regra
- [ ] Handle `onDragEnd` ‚Üí atualizar prioridades no DB
- [ ] Feedback visual durante drag (overlay, cursor)

**Arquivo modificado:**
- `app/settings/classification-rules/page.tsx`

---

#### Task 1.2: Testes de dnd-kit
- [ ] Test: Drag regra de posi√ß√£o 1 para 3
- [ ] Test: Prioridades s√£o atualizadas corretamente
- [ ] Test: Feedback visual aparece durante drag

**Arquivo:**
- `tests/integration/classification-rules.test.tsx` (NOVO)

---

### **Sprint 2: Wizard de Importa√ß√£o (3 dias)**

#### Task 2.1: Multi-Step Form
- [ ] Criar `app/import/wizard/page.tsx`
- [ ] Step 1: Upload de arquivo (drag-and-drop zone)
- [ ] Step 2: Detec√ß√£o autom√°tica de formato (CSV, OFX, PDF)
- [ ] Step 3: Preview de transa√ß√µes (tabela)
- [ ] Step 4: Mapeamento de colunas (se CSV)
- [ ] Step 5: Revis√£o e confirma√ß√£o
- [ ] Step 6: Importa√ß√£o com progress bar

**Componentes:**
- `components/import/file-upload-zone.tsx` (NOVO)
- `components/import/preview-table.tsx` (NOVO)
- `components/import/column-mapper.tsx` (NOVO)
- `components/import/import-progress.tsx` (NOVO)

---

#### Task 2.2: Column Mapper Interativo
- [ ] Dropdown para cada coluna do CSV
- [ ] Op√ß√µes: data, descri√ß√£o, valor, tipo, categoria (opcional)
- [ ] Preview live ao mudar mapeamento
- [ ] Salvar mapeamento como template

**Arquivo:**
- `components/import/column-mapper.tsx` (NOVO)

---

### **Sprint 3: P√°gina de Analytics (4 dias)**

#### Task 3.1: Criar P√°gina /analytics
- [ ] Criar `app/analytics/page.tsx`
- [ ] Layout: Grid responsivo (2 colunas desktop, 1 mobile)
- [ ] Filtros: per√≠odo (m√™s, trimestre, ano)
- [ ] Export de relat√≥rios (PDF com jsPDF)

**Arquivo:**
- `app/analytics/page.tsx` (NOVO)

---

#### Task 3.2: Componente - Evolu√ß√£o de Gastos
- [ ] Gr√°fico de linha (Recharts)
- [ ] √öltimos 6 meses
- [ ] Breakdown por categoria (linhas coloridas)
- [ ] Tooltip com detalhes

**Arquivo:**
- `components/analytics/expense-evolution-chart.tsx` (NOVO)

---

#### Task 3.3: Componente - Top 10 Despesas
- [ ] Lista ordenada com badges
- [ ] Mostra: descri√ß√£o, valor, categoria, data
- [ ] Click para ver detalhes da transa√ß√£o

**Arquivo:**
- `components/analytics/top-expenses-widget.tsx` (NOVO)

---

#### Task 3.4: Componente - An√°lise de Tend√™ncias
- [ ] Cards com %: m√™s vs m√™s anterior
- [ ] Badges verde/vermelho (up/down)
- [ ] Categorias com maior varia√ß√£o

**Arquivo:**
- `components/analytics/trend-analysis.tsx` (NOVO)

---

#### Task 3.5: Componente - Taxa de Saving
- [ ] Gauge chart (Recharts)
- [ ] F√≥rmula: (receitas - despesas) / receitas * 100
- [ ] Meta sugerida: 20% (configur√°vel)

**Arquivo:**
- `components/analytics/saving-rate-card.tsx` (NOVO)

---

#### Task 3.6: Componente - Sankey Flow Chart
- [ ] Visualiza√ß√£o de fluxo: Fonte ‚Üí Categoria ‚Üí Tipo
- [ ] Biblioteca: `recharts` ou `react-flow`
- [ ] Interativo (hover mostra valores)

**Arquivo:**
- `components/analytics/sankey-flow-chart.tsx` (NOVO)

---

### **Sprint 4: Melhorias em Or√ßamentos (2 dias)**

#### Task 4.1: Proje√ß√µes de Or√ßamento
- [ ] Algoritmo: m√©dia m√≥vel dos √∫ltimos 3 meses
- [ ] Componente: `projection-chart.tsx`
- [ ] Gr√°fico de barras com proje√ß√£o tracejada

**Arquivo:**
- `components/budget/projection-chart.tsx` (NOVO)

---

#### Task 4.2: Comparativo Or√ßado vs Realizado
- [ ] Card com gr√°fico de barras horizontais
- [ ] Verde: abaixo do or√ßado
- [ ] Vermelho: acima do or√ßado
- [ ] % de utiliza√ß√£o

**Arquivo:**
- `components/budget/comparison-card.tsx` (NOVO)

---

#### Task 4.3: Hist√≥rico de Or√ßamentos
- [ ] Tabela com or√ßamentos dos √∫ltimos 6 meses
- [ ] Colunas: M√™s, Or√ßado, Realizado, Diferen√ßa, %
- [ ] Orden√°vel por coluna

**Arquivo:**
- `components/budget/history-table.tsx` (NOVO)

---

#### Task 4.4: Sugest√µes Inteligentes
- [ ] Algoritmo: analisa √∫ltimos 3 meses
- [ ] Sugere or√ßamento por categoria
- [ ] Mostra outliers (gastos anormais)

**Arquivo:**
- `components/budget/smart-suggestions.tsx` (NOVO)

---

## üìä M√©tricas de Progresso

### **Agent CORE**
- [ ] 0/12 tarefas completas (0%)

### **Agent DATA**
- [ ] 0/9 tarefas completas (0%)

### **Agent APP**
- [ ] 0/15 tarefas completas (0%)

---

## üö¶ Status Semanal

### **Semana 1**
- Agent CORE: Setup testes
- Agent DATA: Parser OFX

### **Semana 2**
- Agent APP: Drag-and-drop + Wizard

### **Semana 3**
- Agent APP: Analytics
- Agent CORE: Testes + CI/CD

---

**√öltima atualiza√ß√£o:** 05 de Novembro de 2025
**Pr√≥ximo update:** Fim da Semana 1
